<story-context>
  <story_id>4-1</story_id>
  <story_title>Implement Automatic Fallback Mechanism</story_title>
  <status>drafted</status>

  <user_story>
    <as_a>backend developer</as_a>
    <i_want>to implement a mechanism to detect when the chatbot cannot confidently answer a question</i_want>
    <so_that>it can gracefully inform the user and provide alternative resources</so_that>
  </user_story>

  <acceptance_criteria>
    <criterion id="1">Low Confidence Detection: The system must accurately detect when the confidence score of a RAG-generated answer falls below a configurable threshold (e.g., 0.7).</criterion>
    <criterion id="2">Fallback Message: When low confidence is detected, the system must return a specific fallback message: "Jeg fant ikke et klart svar i dokumentasjonen for dette spørsmålet. Kan du utdype spørsmålet? ..."</criterion>
    <criterion id="3">Support Link: The fallback response must include a link to the general documentation or a support contact page.</criterion>
    <criterion id="4">No Hallucination: The system must NOT attempt to fabricate an answer when confidence is low.</criterion>
  </acceptance_criteria>

  <tasks>
    <task id="1">Configure Confidence Threshold (AC: 1)</task>
    <task id="2">Implement Detection Logic in Chat Service (AC: 1, 4)</task>
    <task id="3">Implement Fallback Response (AC: 2, 3)</task>
    <task id="4">Testing</task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Detailed Design / Services and Modules</section>
        <snippet>backend/app/services/chat_service.py: Implements core RAG logic... fallback logic for low-confidence answers...</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Detailed Design / Sequence Diagrams</section>
        <snippet>Automatic Fallback Mechanism (Story 4.1): User -> Frontend -> BackendAPI -> ChatService -> ChatService (Evaluate confidence) -> Low Confidence -> Fallback message</snippet>
      </doc>
       <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>backend/app/services/chat_service.py: Business logic, service layer.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code files found in backend/app yet. -->
    </code>
    <dependencies>
      <!-- Inferred from Tech Spec -->
      <dependency>FastAPI</dependency>
      <dependency>Pydantic</dependency>
      <dependency>Pydantic AI</dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Service Layer Pattern: Core logic for confidence detection and fallback must reside in `app/services/chat_service.py`.</constraint>
    <constraint>Pydantic Models: Use `ChatResponse` in `app/schemas/chat.py` to strictly define the API contract.</constraint>
    <constraint>Configuration: Use `app/core/config.py` for the `RAG_CONFIDENCE_THRESHOLD`.</constraint>
  </constraints>

  <tests>
    <standard>Unit tests using Pytest. Integration tests for API endpoints.</standard>
    <idea>Mock low confidence score -> Verify fallback message returned.</idea>
    <idea>Mock high confidence score -> Verify normal answer returned.</idea>
  </tests>
</story-context>
