<story-context id="1-7" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>Set up ChromaDB Vector Store</title>
    <status>drafted</status>
    <generatedAt>2025-12-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-7-set-up-chromadb-vector-store.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>set up and configure the ChromaDB vector store</iWant>
    <soThat>I can efficiently store and retrieve document embeddings for the RAG pipeline</soThat>
    <tasks>
- [ ] **Install and Configure ChromaDB** (AC: 1)
  - [ ] Add `chromadb` to `pyproject.toml` (already should be there, verify).
  - [ ] Configure settings in `app/core/config.py` (e.g., `CHROMA_PERSIST_DIRECTORY`).
- [ ] **Implement Vector Store Module** (AC: 3)
  - [ ] Create `app/rag/vector_store.py`.
  - [ ] Implement `get_chroma_client()` function.
  - [ ] Define the collection name (e.g., `hmsreg_docs`).
- [ ] **Configure Persistence** (AC: 2)
  - [ ] For local dev: Use local file path.
  - [ ] For Railway (Staging): Determine strategy (Docker volume or ephemeral for now if POC). *Note: Tech Spec implies persistent storage is required.*
- [ ] **Verify Functionality** (AC: 4)
  - [ ] Create a test script `tests/test_chroma_init.py`.
  - [ ] Insert a mock vector.
  - [ ] Query the mock vector.
  - [ ] Assert results match.
    </tasks>
  </story>

  <acceptanceCriteria>
1. **ChromaDB Initialized:** The `chromadb` client library is integrated and configured.
2. **Persistent Storage:** The vector store is configured to persist data (e.g., to disk or a persistent volume, depending on environment).
3. **Manager Module:** `app/rag/vector_store.py` is created to encapsulate ChromaDB client interactions.
4. **Verification:** A basic test script or endpoint can successfully add a dummy embedding and retrieve it.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture" section="Data Architecture">
         Specifies ChromaDB for vector storage.
      </doc>
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Tech Spec Epic 1" section="Detailed Design">
         Confirms ChromaDB initialization requirements.
      </doc>
    </docs>
    <code>
      <file path="backend/app/rag/vector_store.py" kind="file" symbol="get_chroma_client" reason="New module for vector store logic" />
    </code>
    <dependencies>
      <ecosystem name="python">
        <package name="chromadb" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
- Use `chromadb.PersistentClient`.
- Configure persistence path via environment variable.
  </constraints>
  <interfaces>
    <interface name="get_chroma_client" kind="function" signature="() -> chromadb.ClientAPI" path="backend/app/rag/vector_store.py" />
  </interfaces>
  <tests>
    <standards>Integration Test.</standards>
    <locations>backend/tests/test_chroma_init.py</locations>
    <ideas>
1. Verify client initializes.
2. Verify create_collection works.
3. Verify add/query vector works.
    </ideas>
  </tests>
</story-context>
